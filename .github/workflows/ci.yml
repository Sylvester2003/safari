name: CI Pipeline (Bun)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write

jobs:
  # 1. INSTALL STAGE
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Installs Bun
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # 'bun install --frozen-lockfile' is the equivalent of 'npm ci'
      - name: Install Dependencies
        run: bun install --frozen-lockfile

  # 2. LINT STAGE
  lint:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # Run the lint script using Bun
      - name: Run Lint Fix
        run: bun run lint:fix

      - name: Commit and Push Lint Fixes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "ðŸ§¼ chore(lint): fixed linting errors"
          branch: ${{ github.head_ref }}

  # 3. TEST STAGE
  test:
    needs: install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      
      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # Bun has a built-in test runner, but if you use Jest/Mocha
      # inside your "test" script, 'bun run test' works perfectly too.
      - name: Run Tests
        run: bun run test

  # 4. BUILD STAGE (Native Windows)
  build:
    needs: install
    # Bun now works on Windows too!
    runs-on: windows-latest 
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      # We still need Rust for Tauri
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install Dependencies
        run: bun install --frozen-lockfile

      # Build the App
      - name: Build Tauri App
        run: bun run tauri build

      # Upload Artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: safari-windows-app
          # The path is 'release' because we are doing a native build, not cross-compiling
          path: src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 7
